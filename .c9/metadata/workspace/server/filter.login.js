{"changed":true,"filter":false,"title":"filter.login.js","tooltip":"/server/filter.login.js","value":"var idName = null;\nexports.init = function(config) {\n    idName = config.db.idName;\n}\n\n\nexports.loginCheck = function(reqData, req, res) {\n    if (!req.session.user) {\n        console.log('user session is not existed!');\n        throw new Error('ログイン情報なし');\n    }\n}\n\nexports.addLastUpdate = function(reqData, req) {\n    var method = reqData.method;\n    if (method.indexOf('Update') > 0\n        || method.indexOf('Insert') > 0\n        || method.indexOf('Save') > 0) {\n        \n        if (!reqData.data[idName]) {\n            if (req.session.user) {\n                reqData.data.first_update_user = req.session.user[idName];\n            }\n            reqData.data.first_update_date = new Date().toISOString().replace(/T/, ' ').replace(/\\..+/, '');\n        }\n        \n        if (req.session.user) {\n            reqData.data.last_update_user = req.session.user[idName];\n        }\n        reqData.data.last_update_date = new Date().toISOString().replace(/T/, ' ').replace(/\\..+/, '');\n    }\n}\n\nvar authCheckLogic = {\n    Update : function(authData, reqData, req) {\n        if (authData.save) {\n            var user = req.session.user;\n            var dataName = reqData.dataName;\n            if (authData.save == 0 && user) {\n                return true;\n            /*\n            } else if (authData.save == 1 && user) {\n                if (!user.memberType || user.memberType < authData.save) {\n                    req.query = {last_update_user : user[idName]};\n                }\n                return true;\n            } else if (user.memberType > authData.save) {\n                return true;\n            }\n            */\n            } else if (authData.save == 1 && user) {\n                if (!user._auth || !user._auth[dataName] || user._auth[dataName].save < authData.save) {\n                    req.query = {last_update_user : user[idName]};\n                }\n                return true;\n            } else if (user._auth && user._auth[dataName] && user._auth[dataName].save > authData.save) {\n                return true;\n            }\n            return false;\n        }\n        return true;\n    },\n    reqData : function(authData, reqData, req) {\n        if (req.session && req.session.user) {\n            console.log('last_update_user insert !');\n        \treqData.parm.last_update_user = req.session.user[idName];\n        }\n        if (authData.read) {\n            var user = req.session.user;\n            var dataName = reqData.dataName;\n            if (authData.read == 0 && user) {\n                return true;\n            /*\n            } else if (authData.read == 1 && user) {\n                if (!user.memberType || user.memberType < authData.read) {\n                    if(reqData.parm.$query) {\n                        reqData.parm.$query.last_update_user = user[idName];\n                    } else {\n                        reqData.parm.last_update_user = user[idName];\n                    }\n                }\n                return true;\n            } else if (user.memberType > authData.read) {\n                return true;\n            }\n            */\n            } else if (authData.read == 1 && user) {\n                if (!user._auth || !user._auth[dataName] || user._auth[dataName].read < authData.read) {\n                    if(reqData.parm.$query) {\n                        reqData.parm.$query.last_update_user = user[idName];\n                    } else {\n                        reqData.parm.last_update_user = user[idName];\n                    }\n                }\n                return true;\n            } else if (user._auth && user._auth[dataName] && user._auth[dataName].read > authData.read) {\n                return true;\n            }\n            return false;\n        }\n        return true;\n    }\n}\nauthCheckLogic.Insert = authCheckLogic.Update;\nauthCheckLogic.Save = authCheckLogic.Update;\nauthCheckLogic.Delete = authCheckLogic.Update;\nauthCheckLogic.reqList = authCheckLogic.reqData;\n\nexports.authCheck = function(reqData, req, res) {\n    var method = reqData.method;\n    var authData = bridge_config.loginMethod.authCheck[reqData.dataName];\n    if (authData) {\n\n        for (var key in authCheckLogic) {\n            if (method.indexOf(key) > -1) {\n                if(!authCheckLogic[key](authData, reqData, req)) {\n                    throw new Error('接近不可データー');\n                };\n            }\n        }\n        return true;\n    } else {\n        throw new Error('接近不可データー');\n    }\n\n}","undoManager":{"mark":46,"position":47,"stack":[[{"group":"doc","deltas":[{"start":{"row":80,"column":40},"end":{"row":80,"column":41},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":80,"column":26},"end":{"row":80,"column":27},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":80,"column":65},"end":{"row":80,"column":66},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":88,"column":41},"end":{"row":88,"column":42},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":88,"column":28},"end":{"row":88,"column":29},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":88,"column":66},"end":{"row":88,"column":67},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":25},"end":{"row":31,"column":29},"action":"remove","lines":["read"]},{"start":{"row":31,"column":25},"end":{"row":31,"column":26},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":26},"end":{"row":31,"column":27},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":27},"end":{"row":31,"column":28},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":31,"column":28},"end":{"row":31,"column":29},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":44,"column":26},"end":{"row":44,"column":27},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":44,"column":41},"end":{"row":44,"column":42},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":44,"column":65},"end":{"row":44,"column":66},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":48,"column":64},"end":{"row":48,"column":65},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":48,"column":41},"end":{"row":48,"column":42},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":48,"column":28},"end":{"row":48,"column":29},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":18,"column":8},"end":{"row":19,"column":0},"action":"insert","lines":["",""]},{"start":{"row":19,"column":0},"end":{"row":19,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":8},"end":{"row":20,"column":0},"action":"insert","lines":["",""]},{"start":{"row":20,"column":0},"end":{"row":20,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":8},"end":{"row":20,"column":0},"action":"insert","lines":["",""]},{"start":{"row":20,"column":0},"end":{"row":20,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":8},"end":{"row":20,"column":9},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":9},"end":{"row":20,"column":10},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":10},"end":{"row":20,"column":11},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":11},"end":{"row":20,"column":13},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":13},"end":{"row":20,"column":14},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":14},"end":{"row":20,"column":15},"action":"insert","lines":["{"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":15},"end":{"row":22,"column":9},"action":"insert","lines":["","            ","        }"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":12},"end":{"row":20,"column":19},"action":"insert","lines":["reqData"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":12},"end":{"row":20,"column":19},"action":"remove","lines":["reqData"]},{"start":{"row":20,"column":12},"end":{"row":20,"column":24},"action":"insert","lines":["reqData.data"]}]}],[{"group":"doc","deltas":[{"start":{"row":16,"column":27},"end":{"row":16,"column":33},"action":"remove","lines":["Insert"]},{"start":{"row":16,"column":27},"end":{"row":16,"column":33},"action":"insert","lines":["Insert"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":12},"end":{"row":20,"column":24},"action":"remove","lines":["reqData.data"]},{"start":{"row":20,"column":12},"end":{"row":20,"column":32},"action":"insert","lines":["reqData.data[idName]"]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":4},"end":{"row":19,"column":8},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":0},"end":{"row":19,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":18,"column":8},"end":{"row":19,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":12},"end":{"row":19,"column":13},"action":"insert","lines":["!"]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":12},"end":{"row":24,"column":103},"action":"insert","lines":["","        if (req.session.user) {","            reqData.data.last_update_user = req.session.user[idName];","        }","        reqData.data.last_update_date = new Date().toISOString().replace(/T/, ' ').replace(/\\..+/, '');"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":0},"end":{"row":21,"column":4},"action":"insert","lines":["    "]},{"start":{"row":22,"column":0},"end":{"row":22,"column":4},"action":"insert","lines":["    "]},{"start":{"row":23,"column":0},"end":{"row":23,"column":4},"action":"insert","lines":["    "]},{"start":{"row":24,"column":0},"end":{"row":24,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":19,"column":36},"end":{"row":20,"column":12},"action":"remove","lines":["","            "]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":32},"end":{"row":21,"column":33},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":31},"end":{"row":21,"column":32},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":30},"end":{"row":21,"column":31},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":29},"end":{"row":21,"column":30},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":29},"end":{"row":21,"column":30},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":30},"end":{"row":21,"column":31},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":31},"end":{"row":21,"column":32},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":32},"end":{"row":21,"column":33},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":33},"end":{"row":21,"column":34},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":23,"column":25},"end":{"row":23,"column":29},"action":"remove","lines":["last"]},{"start":{"row":23,"column":25},"end":{"row":23,"column":30},"action":"insert","lines":["first"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":29},"end":{"row":21,"column":46},"action":"remove","lines":["first_update_user"]},{"start":{"row":21,"column":29},"end":{"row":21,"column":46},"action":"insert","lines":["first_update_user"]}]}]]},"ace":{"folds":[],"customSyntax":"javascript","scrolltop":120,"scrollleft":0,"selection":{"start":{"row":21,"column":46},"end":{"row":21,"column":46},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":473,"mode":"ace/mode/javascript"}},"timestamp":1428851288959}