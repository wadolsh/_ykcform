<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>奉仕記録</title>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/app.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
    		<div id="login" class="br-tmpl form-signin panel-body navbar-right" role="form">
                <script type="text/tmpl" data-tmpl-id="login">
                
                    ##if(data.isSignup) {##
                        <h3>ユーザー登録</h3>
                        <input type="text" name="login_id" value="" class="form-control" placeholder="ID"/>
                        <input type="password" name="password" value="" class="form-control" placeholder="パスワード"/>
                        <input type="password" name="password2" value="" class="form-control" placeholder="パスワード確認"/>
                        <input type="text" name="name" value="" class="form-control" placeholder="お名前"/>
                        <input type="email" name="email" value="" class="form-control" placeholder="E-mail"/>
                        <br/>
                        <button data-event="##:model.signupInsert##" class="btn btn-primary">登録</button>
                        <button data-event="##:model.signupCancel##" class="btn">キャンセル</button>
                    ##} else if(!data._id) {##
                    <a href="#" data-event="##:model.signup##" class="">ユーザー登録</a>
                    <input type="text" name="login_id" value="" class="form-control" placeholder="ID"/>
                    <input type="password" name="password" value="" class="form-control" placeholder="パスワード"/>
                    <label><input type="checkbox" name="keep_login" value="checked" ##=data.keep_login##/>ログイン保存</label>
                    <button data-event="##:model.login##" class="btn btn-lg btn-primary btn-block">Sign In</button>
                    ##} else {##
                    <span>##=data.name##</span>
                    <button data-event="##:model.logout##" class="btn btn-primary btn-xs">Sign Out</button>
                    ##}##
                </script>
    		</div>
            <div id="message" class="br-tmpl ">
                <script type="text/tmpl" data-tmpl-id="message">
                    <div>##=data.msg##</div>
                </script>
            </div>
        </div>
    </nav>
    
	<div class="container">
	    <div id="edit" class="br-tmpl">
	        <script type="text/tmpl" data-tmpl-id="edit">
                <div class="panel panel-default">
            		<div class="panel-heading" data-toggle="collapse" data-parent="#edit" href="#editArea">
                        <span class="glyphicon glyphicon-pencil"></span>
                        &nbsp;&nbsp;<span>入力</span>
                        ##=(data._id ? ' << 編集モード >>' : '')##
                    </div>
            		<div id="editArea" class="form-horizontal form-edit panel-body collapse" role="form">
            		    <input type="hidden" name="_id" value="##=data._id##">
            			<div class="row">
                			<div class="form-group col-sm-6">
                				<label for="serviceDate" class="col-xs-4 col-md-3 col-lg-3 control-label">日付</label>
                				<div class="col-xs-6 col-md-6">
                				    <input type="date" class="form-control" id="serviceDate" name="serviceDate" value="##=data.serviceDate##" placeholder="日付">
                				</div>
                			</div>
                			<div class="form-group col-sm-6">
                				<label for="serviceTime" class="col-xs-4 col-md-3 col-lg-3 control-label">記録時間</label>
                				<div class="col-xs-6 col-md-6">
                					<input type="time" step="1800" list="timeList" class="form-control" id="serviceTime" name="serviceTime"  value="##=data.serviceTime##" placeholder="日付">
                					<datalist id="timeList">
                						<option value="01:00">
                						<option value="01:30">
                						<option value="02:00">
                						<option value="02:30">
                						<option value="03:00">
                						<option value="03:30">
                						<option value="04:00">
                						<option value="04:30">
                						<option value="05:00">
                						<option value="05:30">
                						<option value="06:00">
                						<option value="06:30">
                						<option value="07:00">
                						<option value="07:30">
                						<option value="08:00">
                						<option value="08:30">
                						<option value="09:00">
                						<option value="09:30">
                						<option value="10:00">
                					</datalist>
                				</div>
                			</div>
                		</div>
                		<div class="row">
                			<div class="form-group col-sm-6">
                				<label for="calcBooks" class="col-xs-4 col-md-3 col-lg-3 control-label">本</label>
                				<div class="col-xs-6 col-sm-4">
                					<input type="number" id="calcBooks" name="calcBooks" value="##=data.calcBooks##" class="form-control"/>
                				</div>
                			</div>
                			<div class="form-group col-sm-6">
                				<label for="calcMagazines" class="col-xs-4 col-md-3 col-lg-3 control-label">雑誌</label>
                				<div class="col-xs-6 col-sm-4">
                					<input type="number" id="calcMagazines" name="calcMagazines" value="##=data.calcMagazines##" class="form-control"/>
                				</div>
                			</div>
                		</div>
                        <div class="row">
                			<div class="form-group col-md-6">
                				<label for="serviceComment" class="col-xs-4 col-sm-2 col-md-3 col-lg-3 control-label">コメント</label>
                				<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
                				  <textarea class="form-control" id="serviceComment" name="serviceComment">##=data.serviceComment##</textarea>
                				</div>
                			</div>
                        </div>
                		<div class="row">
                			<div class="form-group col-md-12">
                				<div class="col-xs-offset-1 col-xs-10">
                					<button data-event="##:model.save##" class="btn btn-primary">登録</button>
                					<button data-event="##:model.saveCancel##" class="btn">キャンセル</button>
                				</div>
                			</div>
                		</div>
            		</div>
        		</div>
            </script>
	    </div>
	    
		<div id="serviceTable" class="panel panel-default table-responsive br-tmpl">
		    <script type="text/tmpl" data-tmpl-id="serviceTable">
        		<div class="panel-heading">奉仕記録</div>
        		<div class="panel-body">
        			<input id="serviceDateMonth" type="month" value="##=data.searchMonth##" data-event="##:model.searchMonthChange##"/>
        			&nbsp;&nbsp;<span id="searchMonthClear" class="glyphicon glyphicon-remove" data-event="##:model.searchMonthClear##">
        		</div>
        		<table class=" table table-bordered">
                    <thead>
                        <tr class="active">
        					<th></th>
                            <th>日付</th>
                            <th>奉仕時間</th>
                            <th>本</th>
                            <th>雑誌</th>
        					<th>コメント</th>
                        </tr>
                    </thead>
                    <tbody>
        				##totalData={};##
                        ##$.each(data.list || {} , function(ind, obj) {##
                        <tr>
        					##
        					var tmpTime = obj.serviceTime ? obj.serviceTime.split(":") : "0:0";
        					totalData.hour = totalData.hour ? totalData.hour + new Number(tmpTime[0]) : new Number(tmpTime[0]);
        					totalData.minute = totalData.minute ? totalData.minute + new Number(tmpTime[1]) : new Number(tmpTime[1]);
        					
        					totalData.totalCalcBooks = totalData.totalCalcBooks ? totalData.totalCalcBooks + new Number(obj.calcBooks) : new Number(obj.calcBooks);
        					totalData.totalCalcMagazines = totalData.totalCalcMagazines ? totalData.totalCalcMagazines + new Number(obj.calcMagazines) : new Number(obj.calcMagazines);
        					##
                            <td>
        						<button data-ind="##=ind##" data-id="##=obj._id##" data-event="##:model.lineEdit##" class="btn btn-default btn-xs">修正</button>
        						<button data-event="##:model.lineDelete##" class="btn btn-default btn-xs">削除</button>
        					</td>
                            <td>##=obj.serviceDate##</td>
                            <td>##=obj.serviceTime##</td>
                            <td>##=obj.calcBooks##</td>
                            <td>##=obj.calcMagazines##</td>
        					<td>##=obj.serviceComment##</td>
                        </tr>
                        ##});##
                    </tbody>
                    <tfoot>
                        <tr class="active">
        					<th></th>
                            <th>総計 >></th>
                            <th id="totalServiceTime">##=Math.floor(totalData.hour + (totalData.minute / 60)) || '00'##:##=(totalData.minute % 60) || '00'##</th>
                            <th id="totalCalcBooks">##=totalData.totalCalcBooks##</th>
                            <th id="totalCalcMagazines">##=totalData.totalCalcMagazines##</th>
                            <th></th>
                        </tr>
                    </tfoot>
        		</table>
            </script>
		    
		</div>
	</div>

    <script src="js/jquery-2.1.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/bridge.core.js"></script>
    <script type="text/javascript">
    
        $.ajaxSetup({
            //async : false,
            complete : function(jqXHR, textStatus) {
            },
            error : function(jqXHR, textStatus, errorThrown ) {
                if (jqXHR.status == 404) {
                    Bridge.msg("サーバーとの通信時にエラーが発生しました。");
                }
                log(textStatus + " : " + errorThrown);
            }
        });
        
        Bridge.idName = '_id';

        var mydata = new Bridge.Connector({dataName : "service_time",
            //url: navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/) ? "https://bridge-c9-choish.c9.io/bridge" : "/bridge"});
            url: navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)
                         ?  ((document.URL.indexOf( 'http://' ) === -1 && document.URL.indexOf( 'https://' ) === -1) ? "http:" : "") + "//ykcform.herokuapp.com/bridge" : "/bridge"});

        var listData = {};
        var totalData = {};
        
        var model = {
			lineEdit: {click: function(e) {
					e.stopPropagation();
					mydata.reqData('eventData', e.data._id).request(function(data, textStatus, jqXHR) {
						var data = data['eventData'];
						Bridge.tmplTool.render('edit', data);
						$('#editArea').collapse('show');
					});
					//alert(e.data.mark);
			}},
			lineDelete: {click: function(e) {
					e.stopPropagation();
					if (!confirm(e.data.serviceDate + ' の記録を作成してもよろしいでしょか？')) {
					    return false;
					}
					
					mydata.reqDelete('reqDelete', e.data._id).request(function(data, textStatus, jqXHR) {
						var data = data['reqDelete'];
						//$(e.target).parents('td').remove();
						model.listAreaReset();
					});
					//alert(e.data.mark);
			}},
			submit: {click: function(e) {
					var template = $(e.target).parents('.br-tmpl');
					var obj = Bridge.tmplTool.editor(template);
					mydata.reqSave('reqSave', obj.data).request(function(data) {
						var data = data['reqSave'];
						model.listAreaReset();
					});
			}},
			
            save: {click: function(e) {
                var template = $(e.target).parents('.br-tmpl');
                var obj = Bridge.tmplTool.editor(template, {
                    serviceDate : {validateRule : {label: '日付', isNullAble : false}},
                    serviceTime : {validateRule : {label: '記録時間', isNullAble : false}},
                    renderMessage : function(strArray) {
                        $(this.target).after('<span>' + strArray.join('<br/>') + '</span>')
                        .parents('.form-group').addClass('has-error');
                    },
                    clearError : function(strArray) {
                        var $target = $(this.target);
                        $target.next('span').remove();
                        $target.parents('.form-group').removeClass('has-error');
                    }
                });
                if (obj.validate()) {
                    //delete obj.data._id;
                    mydata.reqSave('reqSave', obj.data).request(function(data) {
                        model.listAreaReset();
                        Bridge.tmplTool.render('edit', {});
                    });
                }
            }},
            saveCancel: {click: function(e) {
                Bridge.tmplTool.render('edit', {});
            }},
            update: {click: function(e) {
                
                var template = $(e.target).parent('.br-tmpl');
                var obj = Bridge.tmplTool.editor(template);
                mydata.reqUpdate('reqInsert', obj.data._id, obj.data).request(function(data) {
                    model.listAreaReset();
                });
            }},
			searchMonthChange: {change: function(e) {
				model.listAreaReset();
			}},
			searchMonthClear: {click: function(e) {
			    $('#serviceDateMonth').val(null);
				model.listAreaReset();
			}},
			
			signup: {click: function(e) {
			    Bridge.tmplTool.render('login', {isSignup: true});
			}},
			signupInsert: {click: function(e) {
    			var template = $(e.target).parents('.br-tmpl');
                var obj = Bridge.tmplTool.editor(template, {
                    login_id : {validateRule : {label: 'ID', isNullAble : false}},
                    name : {validateRule : {label: 'ID', isNullAble : false}},
                    password : {validateRule : {label: 'パスワード', isNullAble : false}},
                    password2 : {validateRule : {label: 'パスワード確認', isNullAble : false}},
                    //email : {validateRule : {label: 'E-mail', patterns : 'email'}},
                    renderMessage : function(strArray) {
                        Bridge.tmplTool.render('message', {msg : strArray.join('<br/>')});
                    },
                    clearError : function(strArray) {

                    }
                });
                
			    if (obj.validate()) {
                    mydata.reqExecMethod('reqExecSignup', 'signup', obj.data).request(function(data) {
                        if (data['reqExecSignup']._id) {
                            Bridge.tmplTool.render('login', {isSignup: false});
                            model.messageAreaReset({msg : 'ユーザーを登録しました。'});
                        } else {
                            model.messageAreaReset(data['reqExecSignup']);
                        }
                    });
			    }		    
			}},
			signupCancel: {click: function(e) {
			    Bridge.tmplTool.render('login', {isSignup: false});
			}},
            login: {click: function(e) {
                var template = $(e.target).parent('.br-tmpl');
                var obj = Bridge.tmplTool.editor(template);
                Bridge.localStorageTool.push('keepLogin', obj.data.keep_login);
                mydata.reqExecMethod('reqExecLogin', 'login', obj.data).request(function(data) {
                    if (data['reqExecLogin']._id) {
                        console.log(data['reqExecLogin']);
                        model.listAreaReset();
                        model.loginAreaReset();
                    } else {
                        model.messageAreaReset(data['reqExecLogin']);
                    }

                });
            }},
            logout: {click: function(e) {
                var template = $(e.target).parent('.br-tmpl');
                var obj = Bridge.tmplTool.editor(template);
                mydata.reqExecMethod('reqExecLogout', 'logout', obj.data).request(function(data) {
                    console.log(data['reqExecLogout']);
                    Bridge.tmplTool.reset({login: {keep_login : Bridge.localStorageTool.get('keepLogin')}, edit: null, serviceTable: null});
                });
            }},
            
            loginAreaReset: function() {
                mydata.reqExecMethod('loginChecker', 'loginChecker').request(function(data) {
                    data.loginChecker['keep_login'] = Bridge.localStorageTool.get('keepLogin');
                    Bridge.tmplTool.render('login', data.loginChecker);
					if (data.loginChecker._id) {
						model.listAreaReset();
						Bridge.tmplTool.render('edit', {});
					}
                });

            },
            
            listAreaReset: function() {
				var serviceDateMonth = $('#serviceDateMonth').val();
				var param = {$query: {}, $orderby: {serviceDate : 1}};
				if (serviceDateMonth) {
					param.$query = {serviceDate: {$regex : serviceDateMonth}};
				}
                mydata.reset().reqList('reqList', param).request(function(data, textStatus, jqXHR) {
                    listData = data['reqList'];
                    model.messageAreaReset(data);
                    Bridge.tmplTool.render('serviceTable', {searchMonth : serviceDateMonth, list : listData});
                });
            },
            
            messageAreaReset: function(data) {
                data = data || {};
                Bridge.tmplTool.render('message', {msg : data.msg || data.error || data.warm});
            }
        };

Bridge.tmplTool.addTmpl($('[data-tmpl-id]'));
//Bridge.RouterTool.init();


//model.listAreaReset();
        //Bridge.tmplTool.resetAll();
        if (Bridge.localStorageTool.get('keepLogin')) {
            model.loginAreaReset();
        } else {
            Bridge.tmplTool.render('login', {});
        }
    </script>
</body>
</html>