<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>タイトル</title>
</head>
<body>
    
    <div id="message" class="tmpl">
        <div>#=data.msg#</div>
    </div>
    
    <div id="login" class="tmpl">
        #if(!data.name) {#
        <input type="text" name="login_id" value=""/>
        <input type="password" name="password" value=""/>
        <input type="submit" value="Sign In" data-event="#:model.login#"/>
        #} else {#
        <span>#=data.name#</span>
        <input type="submit" value="Sign Out" data-event="#:model.logout#"/>
        #}#
    </div>

    <div id="edit" class="tmpl">
        <input type="hidden" name="_id" value="#=data._id#"/>
        <input type="text" name="text" value="#=data.text#"/>
        <input type="submit" value="修正" data-event="#:model.update#"/>
        <input type="submit" value="新規追加" data-event="#:model.insert#"/>
    </div>

    <div id="list" class="tmpl">
        <ul>
            #$.each(data || {} , function(ind, obj) {#
                <li data-ind="#=ind#" data-id="#=obj._id#" data-event="#:model.oneline#">#=obj.text# <span data-event="#:model.lineDelete#"> delete </span></li>
            #});#
        </ul>
    </div>
    
    <div id="result"></div>
    
    
    <script src="js/jquery-2.1.0.min.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/bridge.core.js"></script>
    <script type="text/javascript">
    
        $.ajaxSetup({
    		async : false,
    		complete : function(jqXHR, textStatus) {
    		},
    		error : function(jqXHR, textStatus, errorThrown ) {
    			if (jqXHR.status == 404) {
    				Bridge.msg("サーバーとの通信時にエラーが発生しました。");
    			}
    			log(textStatus + " : " + errorThrown);
    		}
    	});
    
    
        var mydata = new Bridge.Connector({dataName : "mydata",
                    url: navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/) ? "https://bridge-c9-choish.c9.io/bridge" : "/bridge"});
        
        var listData = {};
        
        var model = {
                oneline: {click: function(e) {
                        e.stopPropagation();
                        mydata.reqData('eventData', e.data._id).request(function(data, textStatus, jqXHR) {
    				        var data = data['eventData'];
    				        Bridge.tmplTool.render('edit', data);
    		        	});
                        //alert(e.data.mark);
                }},
                lineDelete: {click: function(e) {
                        e.stopPropagation();
                        mydata.reqDelete('reqDelete', e.data._id).request(function(data, textStatus, jqXHR) {
    				        var data = data['reqDelete'];
    				        $(e.target).parent().remove();
    		        	});
                        //alert(e.data.mark);
                }},
                			submit: {click: function(e) {
			    var template = $(e.target).parent('.tmpl');
			    var obj = Bridge.tmplTool.editor(template);
	            mydata.reqSave('reqSave', obj.data).request(function(data) {
                    var data = data['reqSave'];
                    model.listAreaReset();
                });
	        }},
			insert: {click: function(e) {
			    var template = $(e.target).parent('.tmpl');
			    var obj = Bridge.tmplTool.editor(template);
			    delete obj.data._id;
	            mydata.reqInsert('reqInsert', obj.data).request(function(data) {
                    model.listAreaReset();
                });
	        }},
			update: {click: function(e) {
			    var template = $(e.target).parent('.tmpl');
			    var obj = Bridge.tmplTool.editor(template);
	            mydata.reqUpdate('reqInsert', obj.data._id, obj.data).request(function(data) {
                    model.listAreaReset();
                });
	        }},
	        login: {click: function(e) {
			    var template = $(e.target).parent('.tmpl');
			    var obj = Bridge.tmplTool.editor(template);
	            mydata.reqExecMethod('reqExecLogin', 'login', obj.data).request(function(data) {
                    console.log(data['reqExecLogin']);
                    model.listAreaReset();
                    model.loginAreaReset();
                });
	        }},
	        logout: {click: function(e) {
			    var template = $(e.target).parent('.tmpl');
			    var obj = Bridge.tmplTool.editor(template);
	            mydata.reqExecMethod('reqExecLogout', 'logout', obj.data).request(function(data) {
                    console.log(data['reqExecLogout']);
                    model.listAreaReset();
                    model.loginAreaReset();
                });
	        }},
	        
            loginAreaReset: function() {
                mydata.reqExecMethod('loginChecker', 'loginChecker').request(function(data) {
                    Bridge.tmplTool.render('login', data.loginChecker);
                });
            },
            
            listAreaReset: function() {
                mydata.reset().reqList('reqList', {}).request(function(data, textStatus, jqXHR) {
                    listData = data['reqList'];
                    model.messageAreaReset(data);
                    Bridge.tmplTool.render('list', listData);
                });
            },
            
            messageAreaReset: function(data) {
                data = data || {};
                Bridge.tmplTool.render('message', {msg : data.msg || data.error || data.warm});
            }
        };

        Bridge.tmplTool.resetAll();
        model.loginAreaReset();
    </script>
</body>
</html>